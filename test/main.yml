---

- hosts: all
  vars:
    checkout_path: ./tmp
    git_public_url: https://github.com/cchurch/ansible-sign.git
    git_public_path: "{{checkout_path}}/git-public"
    git_public_default_version: "master"
    git_public_alternate_version: 3e520efb681dacee45ac49c91ca38f48984b8f21
    svn_public_url: https://github.com/cchurch/ansible-sign
    svn_public_path: "{{checkout_path}}/svn-public"
  pre_tasks:
    - name: remove checkout path
      file:
        path: "{{checkout_path}}"
        state: absent
  roles:
    - role: cchurch.scm
      scm_url: "{{git_public_url}}"
      scm_target_path: "{{git_public_path}}"
      scm_notify_on_updated: "git public handler initial"
    - role: cchurch.scm
      scm_url: "{{git_public_url}}"
      scm_target_path: "{{git_public_path}}"
      scm_notify_on_updated: "git public handler no change"
    - role: cchurch.scm
      scm_url: "{{git_public_url}}"
      scm_target_path: "{{git_public_path}}"
      scm_delete_on_update: true
      scm_notify_on_updated: "git public handler delete on update"
    - role: cchurch.scm
      scm_url: "{{git_public_url}}"
      scm_target_path: "{{git_public_path}}"
      scm_version: "{{git_public_alternate_version}}"
      scm_notify_on_updated: "git public handler version change"
    - role: cchurch.scm
      scm_url: "{{git_public_url}}"
      scm_target_path: "{{git_public_path}}"
      scm_version: "{{git_public_default_version}}"
      scm_notify_on_updated: "git public handler back to default"
    - role: cchurch.scm
      scm_type: svn
      scm_url: "{{svn_public_url}}"
      scm_target_path: "{{svn_public_path}}"
      scm_notify_on_updated: "svn public handler initial"
    - role: cchurch.scm
      scm_type: svn
      scm_url: "{{svn_public_url}}"
      scm_target_path: "{{svn_public_path}}"
      scm_notify_on_updated: "svn public handler no change"
  handlers:
    - name: git public handler initial
      set_fact:
        git_public_notified_initial: true
      changed_when: true
      notify:
        - foo handler
        - bar handler
    - name: foo handler
      set_fact:
        foo_notified: true
    - name: bar handler
      set_fact:
        bar_notified: true
    - name: git public handler no change
      set_fact:
        git_public_notified_no_change: true
    - name: git public handler delete on update
      set_fact:
        git_public_notified_delete_on_update: true
    - name: git public handler version change
      set_fact:
        git_public_notified_version_change: true
    - name: git public handler back to default
      set_fact:
        git_public_notified_back_to_default: true
    - name: svn public handler initial
      set_fact:
        svn_public_notified_initial: true
    - name: svn public handler no change
      set_fact:
        svn_public_notified_no_change: true

- hosts: all
  tasks:
    - assert:
        that:
          - git_public_notified_initial
          - foo_notified
          - bar_notified
          - git_public_notified_no_change is not defined
          - git_public_notified_delete_on_update
          - git_public_notified_version_change
          - git_public_notified_back_to_default
      when: git_public_url is defined
    - assert:
        that:
          - svn_public_notified_initial
          - svn_public_notified_no_change is not defined
      when: svn_public_url is defined
